# 任务清单：增强表单设计器嵌套对象字段支持

## 前置条件
- [x] 审查现有代码结构（FormDesigner, FormPreview, PreviewField, FieldDesigner）
- [x] 确认 PreviewField 已支持对象字段递归渲染

## 实现任务

### 1. 数据结构与验证层（基础）
**优先级：P0** | **预估：1h** | **依赖：无**

- [x] **1.1** 在 `src/stores/forms.js` 的 `validateFormStructure` 方法中添加嵌套层级检查
  - 检查 `object` 类型字段的 `fields` 数组
  - 确保子字段类型不为 `object` 或 `array`
  - 返回清晰的错误消息（如"对象字段的子字段不支持 object/array 类型"）
  
- [x] **1.2** 为子字段生成唯一 ID 的工具函数
  - 在 FormDesigner 组件中添加 `generateSubFieldId()` 函数
  - 格式：`sub_${timestamp}_${counter}` 或 `sub_${parentId}_${index}`
  
- [ ] **1.3** 单元测试（可选）
  - 测试验证逻辑能正确拒绝三层嵌套
  - 测试 ID 生成的唯一性

**验证标准**：
- 加载包含非法嵌套的表单时显示验证错误
- 保存时阻止提交并给出明确提示

---

### 2. FormDesigner UI 增强（核心）
**优先级：P0** | **预估：3h** | **依赖：1.2**

- [x] **2.1** 在 `<el-table-column label="操作">` 中添加条件按钮
  - 仅当 `row.type === 'object'` 时显示"管理子字段"按钮（图标：`Setting` 或 `Edit`）
  - 按钮点击触发 `openSubFieldDialog(index, row)`
  
- [x] **2.2** 添加对话框状态管理
  ```javascript
  const subFieldDialog = reactive({
    visible: false,
    parentField: null,     // 当前编辑的父字段对象
    parentIndex: -1,       // 父字段在顶层 fields 数组中的索引
    subFields: []          // 编辑中的子字段列表（深拷贝）
  });
  ```
  
- [x] **2.3** 创建子字段编辑对话框
  - 使用 `<el-dialog>` 标题为"管理子字段：{parentField.name}"
  - 宽度 70%，最大宽度 1000px
  - footer 包含"关闭"按钮（自动保存，无需"确认"）
  
- [x] **2.4** 对话框内表格结构
  - 复用顶层表格的列结构（序号、字段名称、类型、必填、示例值、操作）
  - 类型选择器过滤：仅显示 `text`, `number`, `date`, `boolean`（使用 computed 过滤 fieldTypes）
  - 操作列：上移、下移、删除（无"管理子字段"按钮）
  
- [x] **2.5** 对话框操作方法
  - `addSubField()`: 添加新子字段到 `subFieldDialog.subFields`
  - `updateSubField(index, field)`: 更新子字段
  - `deleteSubField(index)`: 删除子字段
  - `moveSubFieldUp(index)`: 上移子字段
  - `moveSubFieldDown(index)`: 下移子字段
  - `closeSubFieldDialog()`: 关闭时将 `subFieldDialog.subFields` 保存回 `formData.structure.fields[parentIndex].fields`

**验证标准**：
- 点击"管理子字段"按钮后弹出对话框并加载当前子字段列表
- 对话框中添加/编辑/删除子字段后，关闭对话框时数据正确同步
- 类型选择器中不出现 `object` 和 `array` 选项
- 实时预览面板（右侧）能反映子字段变化

---

### 3. FormPreview 渲染验证（验证）
**优先级：P1** | **预估：1h** | **依赖：2.5**

- [x] **3.1** 审查 `PreviewField.vue` 对象字段渲染逻辑
  - 确认 `v-else-if="field.type === 'object'"` 分支正确递归渲染子字段
  - 确认 `updateObjectField` 方法能正确更新嵌套值
  
- [x] **3.2** 手动测试完整流程
  - 创建包含 `object` 字段的表单（如"合同"包含"甲方"、"乙方"、"金额"）
  - 为 object 字段添加 2-3 个子字段（不同类型）
  - 在右侧实时预览面板中验证子字段正确显示
  - 点击顶部"预览"按钮，在全屏对话框中验证布局和示例值
  
- [x] **3.3** 边界测试
  - 对象字段无子字段时显示"暂无子字段"提示
  - 对象字段有子字段但未填写 example 时显示空值占位符

**验证标准**：
- 实时预览和全屏预览中对象字段及其子字段显示正确
- 子字段的示例值、必填标记、类型渲染正确

---

### 4. 样式与交互优化（增强）
**优先级：P2** | **预估：1.5h** | **依赖：2.5**

- [x] **4.1** 表格中对象字段的视觉区分
  - 为 `type === 'object'` 的行添加浅色背景或左侧边框标识
  - 示例值列显示"包含 N 个子字段"提示（如"包含 3 个子字段"）
  
- [x] **4.2** 对话框表格样式
  - 添加 `.sub-field-table` 类，与顶层表格样式保持一致
  - 空状态使用 `<el-empty>` 显示"暂无子字段，点击上方按钮添加"
  
- [x] **4.3** 添加确认提示
  - 删除子字段时弹出 `ElMessageBox.confirm` 确认对话框
  - 关闭对话框时如果有未保存标志（可选），给出提示
  
- [x] **4.4** 响应式布局
  - 对话框在小屏幕（<768px）时调整宽度为 95%
  - 表格列宽度自适应（使用 `min-width` 替代固定 `width`）

**验证标准**：
- 对象字段在表格中有清晰的视觉标识
- 删除子字段有确认提示，避免误操作
- 移动端（模拟器或缩小窗口）布局不破损

---

### 5. 错误处理与用户反馈（健壮性）
**优先级：P1** | **预估：1h** | **依赖：2.5**

- [x] **5.1** 保存前验证
  - 在 `saveForm()` 中调用 `validateForm()`
  - 检查 object 字段是否至少包含一个子字段（可选，根据业务需求）
  - 检查子字段名称不重复
  
- [x] **5.2** 错误消息展示
  - 使用 `ElMessage.error()` 显示验证失败原因
  - 在对话框中高亮错误字段（如重名子字段红框标识）
  
- [x] **5.3** 边界情况处理
  - 加载表单时，如果 object 字段缺少 `fields` 数组，自动初始化为 `[]`
  - 如果历史数据中存在三层嵌套（不应该存在），在加载时给出警告但允许打开

**验证标准**：
- 尝试保存包含非法嵌套的表单时显示清晰错误提示
- 加载异常数据时不崩溃，给出合理提示

---

### 6. 文档与示例（可选）
**优先级：P3** | **预估：0.5h** | **依赖：5.2**

- [x] **6.1** 更新 `loadSample()` 方法
  - 在示例表单中添加一个 `object` 类型字段（如"合同信息"）
  - 包含 2-3 个子字段（如"甲方名称"、"合同金额"、"签订日期"）
  
- [x] **6.2** 代码注释
  - 在 `openSubFieldDialog` 方法上方添加 JSDoc 注释
  - 说明子字段管理的工作流程

**验证标准**：
- 点击"加载示例"后，表单中包含一个带子字段的 object 字段
- 代码注释清晰，便于后续维护

---

## 测试检查清单

### 功能测试
- [ ] 为 object 字段添加子字段（至少 3 个不同类型）
- [ ] 编辑子字段名称、类型、必填状态、示例值
- [ ] 删除子字段（包含确认提示）
- [ ] 上下移动子字段（调整顺序）
- [ ] 保存表单后重新加载，验证子字段数据完整性
- [ ] 在预览面板中查看对象字段及子字段的渲染效果

### 边界测试
- [ ] object 字段无子字段时保存（根据验证规则）
- [ ] 子字段名称重复时保存（应拒绝）
- [ ] 尝试在子字段中选择 object 类型（选项应不存在）
- [ ] 加载包含三层嵌套的历史数据（警告但不崩溃）

### UI/UX 测试
- [ ] 对话框在不同屏幕尺寸下正常显示
- [ ] 表格滚动时 sticky header 正常工作
- [ ] 删除子字段有确认提示
- [ ] 关闭对话框时数据正确保存（无"确认"按钮时实时保存）

### 兼容性测试
- [ ] 现有表单（无 object 字段）加载和编辑正常
- [ ] 现有表单（有 object 字段但无子字段）加载正常，可添加子字段
- [ ] 保存后的表单数据能被 ExtractionsView 正确消费

---

## 完成标准（Definition of Done）
- [x] 所有 P0/P1 任务完成
- [ ] 功能测试和边界测试通过
- [ ] 代码通过 ESLint 检查（`npm run lint`）
- [ ] 至少在 Chrome 和 Firefox 中验证功能正常
- [x] 在实时预览和全屏预览中对象字段渲染正确
- [x] 保存的表单数据结构符合后端 API 要求
- [ ] （可选）更新 PROJECT_SUMMARY.md 记录本次优化

---

## 预估总时间
- P0 任务：~4h
- P1 任务：~2h
- P2 任务：~1.5h
- P3 任务：~0.5h
- **总计**：约 8 小时（1 个工作日）

---

# Patch 1 追加任务

### 7. 示例表单扩充（3 个示例）
**优先级：P2** | **预估：1h** | **依赖：无**

- [x] 7.1 在“加载示例”入口提供 Sample A/B/C 三种示例
- [x] 7.2 Sample A：纯平铺简单字段；Sample B：一个对象带子字段；Sample C：对象 + 数组元素为对象（2-3 子字段）
- [x] 7.3 若暂不做选择器，则默认加载 Sample B，并在按钮旁增加下拉菜单/Popover 进行选择

验证：三种示例均可加载，满足两层嵌套上限。

---

### 8. 可见性选择（公开/个人）
**优先级：P1** | **预估：1h** | **依赖：无**

- [x] 8.1 在 FormDesigner 顶部表单中，与“数据提取数量”同组新增单选：公开/个人
- [x] 8.2 公开：保存时 payload 不带 userId；个人：保存时 payload 携带当前用户 userId
- [x] 8.3 默认值为公开

验证：分别保存两种可见性后，在管理列表中可见差异（见 9）。

---

### 9. 表单管理列表增加“可见性”列
**优先级：P1** | **预估：0.5h** | **依赖：8**

- [x] 9.1 在 `/forms` 列表新增“可见性”列：无 userId 显示“公开”，有 userId 显示“个人”
- [x] 9.2 不影响现有编辑/删除/开关等操作

验证：不同可见性的表单展示正确。

---

### 10. JSON 预览弹窗
**优先级：P2** | **预估：0.5h** | **依赖：无**

- [x] 10.1 移除页面内 JSON 卡片
- [x] 10.2 顶部操作栏新增“查看JSON”按钮（位于“加载示例”之前）
- [x] 10.3 弹出只读 JSON 模态对话框，宽度约 60-70%

验证：按钮可打开 JSON 预览弹窗，页面不再出现内嵌 JSON 卡片。

---

### 11. 结果过滤修正（/forms → /extractions）
**优先级：P1** | **预估：0.5h** | **依赖：无**

- [x] 11.1 从 `/forms` 点击“关联数据结果”跳转 `/extractions?form_id=<id>`
- [x] 11.2 在 Extractions 页使用 `form_id` 过滤并仅显示该表单的数据
- [x] 11.3 回退/前进时保留过滤

验证：仅显示指定表单的结果。

---

### 12. Handsontable 结果视图（新增）
**优先级：P3** | **预估：3h** | **依赖：无**

- [ ] 12.1 新增结果表格组件（保留旧版不动），支持将对象子字段展开为多列（点号或友好标签）
- [ ] 12.2 支持简单字段双击编辑；不可编辑类型只读
- [ ] 12.3 从管理页提供入口切换到新视图或新路由
- [ ] 12.4 与更新 API 对接

验证：复杂结构展示正确，编辑行为生效或有清晰保存机制。
